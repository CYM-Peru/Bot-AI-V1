# Fixes Aplicados - 9 de Noviembre 2025

## Resumen Ejecutivo

Se resolvi√≥ un error cr√≠tico `TypeError: f.map is not a function` que causaba pantallas blancas en m√∫ltiples secciones de la aplicaci√≥n, especialmente en "M√©tricas de Asesores". El problema ra√≠z era la falta de validaciones `Array.isArray()` antes de llamar al m√©todo `.map()` en varios componentes.

## Problema Principal

**Error**: `TypeError: f.map is not a function`
**S√≠ntomas**:
- Pantalla blanca al intentar ver "M√©tricas de Asesores"
- Error persistente despu√©s de hard refresh del navegador
- Error ocurr√≠a despu√©s del login exitoso

**Causa Ra√≠z**:
Cuando los endpoints del backend devuelven datos en formatos inesperados (por ejemplo, cuando hay errores 401 antes del login, o cuando los datos vienen corruptos), el c√≥digo intentaba hacer `.map()` sobre valores que no eran arrays, causando el crash de la aplicaci√≥n.

## Arquitectura del Sistema

### Stack Tecnol√≥gico
- **Frontend**: React + Vite + TypeScript
- **Backend**: Node.js + Express + TypeScript (ejecutado con `npx tsx`)
- **Base de datos**: PostgreSQL (modo: `STORAGE_MODE=postgres`)
- **Servicio**: systemd (servicio `flowbuilder.service`)
- **Servidor web**: nginx (proxy inverso + static files)

### Ubicaciones Importantes
- **C√≥digo fuente**: `/opt/flow-builder/`
- **Frontend compilado**: `/opt/flow-builder/dist/`
- **Nginx config**: `/etc/nginx/sites-enabled/000-wsp.azaleia.com.pe.conf`
- **Nginx snippet**: `/etc/nginx/snippets/flow-builder_api.conf`
- **Servicio systemd**: `/etc/systemd/system/flowbuilder.service`

### Configuraci√≥n de Nginx

Nginx sirve el frontend directamente desde `/opt/flow-builder/dist` con las siguientes reglas:

```nginx
# Sin cach√© para archivos JS/CSS
location ~* \.(js|css)$ {
  root /opt/flow-builder/dist;
  expires -1;
  add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
  add_header Pragma "no-cache";
}

# Sin cach√© para HTML
location ~ \.html$ {
  root /opt/flow-builder/dist;
  expires -1;
  add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
  add_header Pragma "no-cache";
}

# API proxy
location ^~ /api/ {
  proxy_pass http://127.0.0.1:3000;
  # ... headers de proxy
}
```

**IMPORTANTE**: NO es necesario copiar archivos a `/var/www/flow-builder/`. Nginx sirve directamente desde `/opt/flow-builder/dist/`.

## Fixes Aplicados (7 en total)

### Fix 1: App.tsx - Validaci√≥n de Queues y Advisors
**Archivo**: `/opt/flow-builder/src/App.tsx`
**L√≠neas**: 477-487

**Problema**:
El c√≥digo intentaba hacer `.map()` sobre `queuesData.queues` y `advisorsData.advisors` sin validar que fueran arrays. Cuando los endpoints devolv√≠an errores (401), los datos no ten√≠an el formato esperado.

**C√≥digo Original**:
```typescript
const queuesRes = await fetch('/api/admin/queues');
if (queuesRes.ok) {
  const queuesData = await queuesRes.json();
  setQueues((queuesData.queues || []).map((q: any) => ({ id: q.id, name: q.name })));
}
```

**C√≥digo Corregido**:
```typescript
const queuesRes = await fetch('/api/admin/queues');
if (queuesRes.ok) {
  const queuesData = await queuesRes.json();
  const queuesArray = Array.isArray(queuesData?.queues) ? queuesData.queues :
                     (Array.isArray(queuesData) ? queuesData : []);
  setQueues(queuesArray.map((q: any) => ({ id: q.id, name: q.name })));
}

// Similar para advisors
const advisorsRes = await fetch('/api/admin/advisor-presence');
if (advisorsRes.ok) {
  const advisorsData = await advisorsRes.json();
  const advisorsArray = Array.isArray(advisorsData?.advisors) ? advisorsData.advisors :
                       (Array.isArray(advisorsData) ? advisorsData : []);
  setAdvisors(advisorsArray.map((a: any) => ({
    id: a.userId,
    name: a.user.name || a.user.username,
    email: a.user.email,
    isOnline: a.isOnline
  })));
}
```

**Contexto**:
Este c√≥digo se ejecuta en un `useEffect` cada 10 segundos. Antes del login, los endpoints devuelven 401 con `{"error":"unauthorized"}`, lo que causaba que `queuesData.queues` fuera `undefined`.

---

### Fix 2: flow/utils/flow.ts - getMenuOptions
**Archivo**: `/opt/flow-builder/src/flow/utils/flow.ts`
**L√≠nea**: 158

**Problema**:
La funci√≥n `getMenuOptions()` verificaba si `node.menuOptions` exist√≠a y ten√≠a longitud, pero no validaba que fuera un array.

**C√≥digo Original**:
```typescript
export function getMenuOptions(node: FlowNode): MenuOption[] {
  if (node.type !== 'menu') return [];
  const options = node.menuOptions && node.menuOptions.length > 0 ? node.menuOptions : [createMenuOption(0)];
  return options.map((option, idx) => ({
    ...createMenuOption(idx, option),
  }));
}
```

**C√≥digo Corregido**:
```typescript
export function getMenuOptions(node: FlowNode): MenuOption[] {
  if (node.type !== 'menu') return [];
  const options = Array.isArray(node.menuOptions) && node.menuOptions.length > 0 ? node.menuOptions : [createMenuOption(0)];
  return options.map((option, idx) => ({
    ...createMenuOption(idx, option),
  }));
}
```

**Contexto**:
Esta funci√≥n se llama al renderizar nodos de tipo "menu" en la vista previa del flujo. Si los datos del flujo vienen corruptos con `menuOptions` como objeto en vez de array, causaba el crash.

---

### Fix 3: flow/utils/flow.ts - normalizeButtonsData
**Archivo**: `/opt/flow-builder/src/flow/utils/flow.ts`
**L√≠neas**: 105-106

**Problema**:
Similar al anterior, pero con botones. El nullish coalescing (`??`) no captura valores que existen pero no son arrays.

**C√≥digo Original**:
```typescript
export function normalizeButtonsData(data?: Partial<ButtonsActionData> | null): ButtonsActionData {
  const items = (data?.items ?? []).map((item, idx) => ({
    ...createButtonOption(idx, item),
  }));
  const ensuredItems = items.length > 0 ? items : [createButtonOption(0)];
  const maxButtons = data?.maxButtons ?? DEFAULT_BUTTON_LIMIT;
  const moreTargetId = data?.moreTargetId ?? null;
  return { items: ensuredItems, maxButtons, moreTargetId };
}
```

**C√≥digo Corregido**:
```typescript
export function normalizeButtonsData(data?: Partial<ButtonsActionData> | null): ButtonsActionData {
  const itemsArray = Array.isArray(data?.items) ? data.items : [];
  const items = itemsArray.map((item, idx) => ({
    ...createButtonOption(idx, item),
  }));
  const ensuredItems = items.length > 0 ? items : [createButtonOption(0)];
  const maxButtons = data?.maxButtons ?? DEFAULT_BUTTON_LIMIT;
  const moreTargetId = data?.moreTargetId ?? null;
  return { items: ensuredItems, maxButtons, moreTargetId };
}
```

**Contexto**:
Se usa al renderizar nodos con botones interactivos. Previene crashes si `data.items` viene como objeto en vez de array.

---

### Fix 4: MetricsDashboard.tsx - channelDistribution
**Archivo**: `/opt/flow-builder/src/crm/MetricsDashboard.tsx`
**L√≠nea**: 514

**Problema**:
La condici√≥n verificaba existencia y longitud, pero no tipo de dato.

**C√≥digo Original**:
```typescript
{kpis?.channelDistribution && kpis.channelDistribution.length > 0 && (
  <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 className="text-lg font-bold text-slate-900 mb-4">üì± Distribuci√≥n por Canal</h3>
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
      {kpis.channelDistribution.map((ch) => (
        // ...
      ))}
    </div>
  </div>
)}
```

**C√≥digo Corregido**:
```typescript
{kpis?.channelDistribution && Array.isArray(kpis.channelDistribution) && kpis.channelDistribution.length > 0 && (
  <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 className="text-lg font-bold text-slate-900 mb-4">üì± Distribuci√≥n por Canal</h3>
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
      {kpis.channelDistribution.map((ch) => (
        // ...
      ))}
    </div>
  </div>
)}
```

**Contexto**:
Se renderiza en la pesta√±a "General" del dashboard de m√©tricas. Si el endpoint `/api/crm/metrics/advisors/ranking` devuelve datos mal formados, causaba el crash.

---

### Fix 5: MetricsDashboard.tsx - advisorRanking
**Archivo**: `/opt/flow-builder/src/crm/MetricsDashboard.tsx`
**L√≠nea**: 562

**Problema**:
Verificaba solo `.length === 0`, asumiendo que siempre ser√≠a un array.

**C√≥digo Original**:
```typescript
{advisorRanking.length === 0 ? (
  <div className="text-center py-12">
    <div className="text-6xl mb-4">üë•</div>
    <p className="text-lg text-slate-600 mb-2">No hay datos de asesores a√∫n</p>
  </div>
) : (
  // ... tabla con advisorRanking.map()
)}
```

**C√≥digo Corregido**:
```typescript
{!Array.isArray(advisorRanking) || advisorRanking.length === 0 ? (
  <div className="text-center py-12">
    <div className="text-6xl mb-4">üë•</div>
    <p className="text-lg text-slate-600 mb-2">No hay datos de asesores a√∫n</p>
  </div>
) : (
  // ... tabla con advisorRanking.map()
)}
```

**Contexto**:
Este era el componente que causaba el error m√°s frecuente cuando el usuario intentaba ver "M√©tricas de Asesores". El endpoint `/api/crm/metrics/advisors/ranking` a veces devolv√≠a datos en formato incorrecto.

---

### Fix 6: MetricsDashboard.tsx - campaignMetrics
**Archivo**: `/opt/flow-builder/src/crm/MetricsDashboard.tsx`
**L√≠nea**: 652

**Problema**:
Mismo patr√≥n que el fix anterior.

**C√≥digo Original**:
```typescript
{metricsTab === "campaigns" && (
  <>
    {campaignMetrics.length === 0 ? (
      <div className="text-center py-12">
        <div className="text-6xl mb-4">üì¢</div>
        <p className="text-lg text-slate-600 mb-2">No hay campa√±as a√∫n</p>
      </div>
    ) : (
      // ... tabla con campaignMetrics.map()
    )}
  </>
)}
```

**C√≥digo Corregido**:
```typescript
{metricsTab === "campaigns" && (
  <>
    {!Array.isArray(campaignMetrics) || campaignMetrics.length === 0 ? (
      <div className="text-center py-12">
        <div className="text-6xl mb-4">üì¢</div>
        <p className="text-lg text-slate-600 mb-2">No hay campa√±as a√∫n</p>
      </div>
    ) : (
      // ... tabla con campaignMetrics.map()
    )}
  </>
)}
```

**Contexto**:
Se renderiza en la pesta√±a "Campa√±as" del dashboard de m√©tricas.

---

### Fix 7: MetricsDashboard.tsx - trendData
**Archivo**: `/opt/flow-builder/src/crm/MetricsDashboard.tsx`
**L√≠neas**: 288-294

**Problema**:
Los datos de tendencia se usan directamente en Chart.js sin validaci√≥n.

**C√≥digo Original**:
```typescript
const trendChartData = {
  labels: trendData.map((d) => new Date(d.date).toLocaleDateString("es-PE", { month: "short", day: "numeric" })),
  datasets: [
    {
      label: "Conversaciones",
      data: trendData.map((d) => d.count),
      borderColor: "rgb(16, 185, 129)",
      backgroundColor: "rgba(16, 185, 129, 0.1)",
      fill: true,
      tension: 0.4,
    },
  ],
};
```

**C√≥digo Corregido**:
```typescript
const safeTrendData = Array.isArray(trendData) ? trendData : [];
const trendChartData = {
  labels: safeTrendData.map((d) => new Date(d.date).toLocaleDateString("es-PE", { month: "short", day: "numeric" })),
  datasets: [
    {
      label: "Conversaciones",
      data: safeTrendData.map((d) => d.count),
      borderColor: "rgb(16, 185, 129)",
      backgroundColor: "rgba(16, 185, 129, 0.1)",
      fill: true,
      tension: 0.4,
    },
  ],
};
```

**Contexto**:
Los datos de tendencia vienen del endpoint `/api/crm/metrics/trend`. Si falla, evita que el gr√°fico cause un crash.

---

## Proceso de Despliegue

### 1. Compilar Frontend
```bash
cd /opt/flow-builder
npm run build
```

**Output esperado**:
- Bundle generado en `/opt/flow-builder/dist/assets/index-XXXXXXXX.js`
- `index.html` actualizado con referencia al nuevo bundle
- Tiempo de compilaci√≥n: ~6 segundos

**Bundle actual** (al momento de esta documentaci√≥n):
- Nombre: `index-ev2qcj-Y.js`
- Tama√±o: 1.4MB (361KB gzipped)
- Generado: Nov 9 2025, 23:10

### 2. Verificar Despliegue
```bash
# Verificar que el bundle existe
ls -lh /opt/flow-builder/dist/assets/index-*.js

# Verificar que index.html apunta al nuevo bundle
grep -o 'index-[^"]*\.js' /opt/flow-builder/dist/index.html

# Verificar que nginx est√° corriendo
systemctl status nginx

# Verificar que el servicio flowbuilder est√° corriendo
systemctl status flowbuilder
```

### 3. NO es necesario
‚ùå NO copiar archivos a `/var/www/flow-builder/`
‚ùå NO reiniciar nginx (a menos que cambies configuraci√≥n)
‚ùå NO reiniciar el servicio flowbuilder (a menos que cambies backend)

### 4. Limpiar Cach√© del Navegador
El usuario debe hacer:
- **Hard refresh**: Ctrl+Shift+R (Windows/Linux) o Cmd+Shift+R (Mac)
- O abrir en ventana privada/inc√≥gnito
- O en DevTools (F12) ‚Üí Network tab ‚Üí marcar "Disable cache" ‚Üí refrescar

## Contexto Hist√≥rico de la Sesi√≥n

### Problema Inicial Reportado
El usuario report√≥: "acabo de escribir desde el 918131082 y tuve q actualziar para q pueda ver que ese chat este en EN COLA BOT!!!! NO SE SUPONE Q SE DEBE VER EN TIEMPO REAL TODO?"

Esto llev√≥ a investigar varios problemas:

1. **WebSocket real-time updates** - Se encontraron bugs con `await` faltante
2. **Bitrix token expirado** - Se mejor√≥ el auto-refresh scheduler
3. **Endpoints faltantes** - Se crearon `/api/admin/advisor-stats` y `/api/admin/bot-config`
4. **Error f.map** - El problema principal que se resolvi√≥ en esta documentaci√≥n

### Fixes Previos (No Relacionados con f.map)

#### Fix: WebSocket Updates en inbound.ts
**Archivo**: `/opt/flow-builder/server/crm/inbound.ts:136`
```typescript
// Antes (sin await):
const refreshed = crmDb.getConversationById(conversation.id);

// Despu√©s:
const refreshed = await crmDb.getConversationById(conversation.id);
```

#### Fix: Admin Accept Chat
**Archivo**: `/opt/flow-builder/server/crm/routes/conversations.ts:15`
```typescript
// Antes:
const user = adminDb.getUserById(advisorId);

// Despu√©s:
const user = await adminDb.getUserById(advisorId);
```

#### Fix: Bitrix Token Refresh Scheduler
**Archivo**: `/opt/flow-builder/server/index.ts:939`
```typescript
// Antes:
if (timeUntilExpiry < threshold && timeUntilExpiry > 0) {

// Despu√©s (permite refrescar tokens ya expirados):
if (timeUntilExpiry < threshold) {
```

#### Creaci√≥n: /api/admin/advisor-stats
**Archivo**: `/opt/flow-builder/server/routes/admin.ts:436-500`

Endpoint que devuelve:
```json
{
  "advisors": [
    {
      "userId": "user-123",
      "userName": "Juan P√©rez",
      "email": "juan@example.com",
      "role": "asesor",
      "isOnline": true,
      "status": { "id": "status-available", "name": "Disponible" },
      "conversationsByQueue": {
        "queue-1": 3,
        "queue-2": 1
      },
      "totalConversations": 4
    }
  ],
  "queues": [
    { "id": "queue-1", "name": "Ventas" },
    { "id": "queue-2", "name": "Soporte" }
  ]
}
```

#### Creaci√≥n: /api/admin/bot-config
**Archivos modificados**:
- `/opt/flow-builder/server/admin-db.ts` (interfaces y m√©todos)
- `/opt/flow-builder/server/routes/admin.ts` (endpoints GET y PUT)

Estructura de datos:
```typescript
interface BotConfig {
  perFlowConfig: Record<string, {
    botTimeout: number; // en minutos
    fallbackQueue: string; // queue ID
  }>;
  updatedAt: string;
}
```

#### Fix: Metrics Endpoints Async/Await
**Archivo**: `/opt/flow-builder/server/crm/routes/metrics.ts`

Se agreg√≥ `async` y `await` a tres endpoints:
- L√≠nea 87: `/metrics/all`
- L√≠nea 277: `/metrics/dashboard`
- L√≠nea 370: `/metrics/advisors/ranking`

Todos estos endpoints usan `metricsTracker.getAllMetrics()` que en modo PostgreSQL retorna una Promise.

## Comandos √ötiles

### Frontend
```bash
# Compilar frontend
npm run build

# Desarrollo local (no usar en producci√≥n)
npm run dev

# Verificar errores de TypeScript
npx tsc --noEmit
```

### Backend/Servicio
```bash
# Ver estado del servicio
systemctl status flowbuilder

# Ver logs en tiempo real
journalctl -u flowbuilder -f

# Reiniciar servicio (si cambias c√≥digo backend)
systemctl restart flowbuilder

# Ver logs recientes
journalctl -u flowbuilder --since "10 minutes ago"
```

### Nginx
```bash
# Verificar configuraci√≥n
nginx -t

# Recargar configuraci√≥n (sin downtime)
systemctl reload nginx

# Ver logs de acceso
tail -f /var/log/nginx/access.log

# Ver logs de error
tail -f /var/log/nginx/error.log
```

### Debugging
```bash
# Ver qu√© bundle est√° sirviendo nginx
curl -I https://wsp.azaleia.com.pe/assets/index-ev2qcj-Y.js

# Ver respuesta del endpoint de m√©tricas
curl -s http://localhost:3000/api/crm/metrics/advisors/ranking | jq .

# Ver qu√© archivos est√°n en dist/assets
ls -lht /opt/flow-builder/dist/assets/ | head -20
```

## Estado Actual del Sistema

### Servicios Activos
- ‚úÖ flowbuilder.service (systemd) - Backend en puerto 3000
- ‚úÖ nginx - Proxy inverso y servidor est√°tico
- ‚úÖ PostgreSQL - Base de datos

### Archivos Desplegados
- ‚úÖ Frontend: `/opt/flow-builder/dist/` (bundle: index-ev2qcj-Y.js)
- ‚úÖ Backend: Corriendo desde `/opt/flow-builder/server/`
- ‚úÖ Datos: PostgreSQL database

### Configuraciones
- Base de datos: `STORAGE_MODE=postgres` (para CRM, Campaigns, Metrics, Sessions)
- Puerto backend: 3000
- Timezone: America/Lima
- Bitrix: Auto-refresh cada 10 minutos, tokens v√°lidos por ~30 d√≠as

## Patrones de Validaci√≥n Recomendados

### Siempre usar Array.isArray() antes de .map()

‚ùå **MAL**:
```typescript
const items = data.items || [];
items.map(item => ...)  // PELIGRO: data.items podr√≠a ser un objeto con truthy value

const hasItems = data.items && data.items.length > 0;
if (hasItems) {
  data.items.map(...)  // PELIGRO: length > 0 no garantiza que sea array
}
```

‚úÖ **BIEN**:
```typescript
const items = Array.isArray(data?.items) ? data.items : [];
items.map(item => ...)

if (Array.isArray(data?.items) && data.items.length > 0) {
  data.items.map(...)
}
```

### Patr√≥n para datos de API

```typescript
async function loadData() {
  try {
    const response = await fetch('/api/endpoint');
    if (!response.ok) {
      console.error('Error:', response.status);
      return;
    }

    const data = await response.json();

    // Siempre validar antes de usar .map()
    const itemsArray = Array.isArray(data?.items) ? data.items :
                      (Array.isArray(data) ? data : []);

    setItems(itemsArray.map(item => ({
      // transform
    })));
  } catch (error) {
    console.error('Failed to load data:', error);
  }
}
```

## Troubleshooting

### Error: "f.map is not a function" persiste
1. Verificar que el nuevo bundle se compil√≥:
   ```bash
   ls -lh /opt/flow-builder/dist/assets/index-*.js
   ```
2. Verificar que index.html apunta al nuevo bundle:
   ```bash
   grep 'index-' /opt/flow-builder/dist/index.html
   ```
3. Limpiar cach√© del navegador completamente
4. Abrir DevTools ‚Üí Network ‚Üí verificar que se descarga el bundle correcto
5. Buscar en el c√≥digo si hay otros `.map()` sin validar:
   ```bash
   cd /opt/flow-builder
   grep -r "\.map(" src/ --include="*.tsx" | grep -v "Array.isArray"
   ```

### Backend no responde
```bash
# Ver estado
systemctl status flowbuilder

# Ver logs
journalctl -u flowbuilder -n 100

# Reiniciar si es necesario
systemctl restart flowbuilder
```

### Nginx no sirve archivos actualizados
```bash
# Verificar que nginx apunta a /opt/flow-builder/dist
grep "root /opt" /etc/nginx/snippets/flow-builder_api.conf

# Verificar sin cach√© est√° configurado
grep "Cache-Control" /etc/nginx/snippets/flow-builder_api.conf

# Recargar nginx
systemctl reload nginx
```

## Notas Importantes

1. **NO usar PM2** - El sistema usa systemd, no PM2. Los procesos en background de PM2 son de sesiones antiguas.

2. **Deployment es simple** - Solo `npm run build`, no hay pasos adicionales. Nginx sirve directamente desde `dist/`.

3. **Cache-Control est√° deshabilitado** - Para JS/CSS/HTML, as√≠ que los cambios se ven inmediatamente (despu√©s de hard refresh).

4. **PostgreSQL es la √∫nica fuente de verdad** - Todo se almacena en PostgreSQL (conversaciones, m√©tricas, campa√±as, sesiones).

5. **Bitrix tokens se auto-renuevan** - El scheduler corre cada 10 minutos y renueva tokens que expiran en menos de 15 minutos.

## Archivos Modificados en Esta Sesi√≥n

1. `/opt/flow-builder/src/App.tsx`
2. `/opt/flow-builder/src/flow/utils/flow.ts`
3. `/opt/flow-builder/src/crm/MetricsDashboard.tsx`
4. `/opt/flow-builder/FIXES-2025-11-09.md` (este archivo)

Total de cambios: 7 fixes de validaci√≥n de arrays en 3 archivos.

## Pr√≥ximos Pasos Recomendados

1. **Auditor√≠a completa**: Buscar todos los `.map()` en el c√≥digo y agregar validaciones donde falten
2. **Tests unitarios**: Agregar tests para estos casos edge
3. **TypeScript m√°s estricto**: Configurar tipos m√°s estrictos para evitar estos problemas
4. **Error boundaries**: Agregar React Error Boundaries para capturar estos errores sin crashear toda la app
5. **Logging mejorado**: Agregar m√°s logs cuando se detecten datos mal formados

---

**√öltima actualizaci√≥n**: 9 de Noviembre 2025, 23:10
**Bundle actual**: index-ev2qcj-Y.js
**Estado**: ‚úÖ Todos los fixes aplicados y desplegados

---

## Fix Adicional: Datos Corruptos en M√©tricas de Asesores (9 Nov 2025 - 23:27)

### Problema
La tabla de "M√©tricas de Asesores" mostraba objetos JSON crudos en lugar de nombres de asesores:
```
{"queueId":"queue-1762356569837","channelType":"whatsapp","channelId":"865074343358032"}
{"channelType":"whatsapp","channelId":"741220429081783"}
```

### Causa Ra√≠z
Error en las llamadas a `metricsTracker.startConversation()` - faltaba pasar el primer par√°metro `metricId`.

**Firma del m√©todo**:
```typescript
async startConversation(
  id: string,              // 1. ID de la m√©trica
  conversationId: string,  // 2. ID de la conversaci√≥n  
  advisorId: string,       // 3. ID del asesor
  options?: { ... }        // 4. Opciones
)
```

**C√≥digo incorrecto** (en `server/crm/routes/conversations.ts` y `messages.ts`):
```typescript
metricsTracker.startConversation(conversation.id, advisorId, {
  queueId: conversation.queueId || undefined,
  channelType: conversation.channel as any,
  channelId: conversation.channelConnectionId || undefined,
});
```

Esto pasaba solo 3 par√°metros, causando que:
- `conversation.id` se usara como `id` de m√©trica ‚úÖ
- `advisorId` se usara como `conversationId` ‚ùå
- El objeto de `options` se usara como `advisorId` ‚ùå

Por eso en la base de datos se guardaban objetos JSON en la columna `advisor_id`.

### Soluci√≥n Aplicada

#### 1. Correcci√≥n en `server/crm/routes/conversations.ts` (l√≠nea 393)
```typescript
// Antes:
metricsTracker.startConversation(conversation.id, advisorId, {
  queueId: conversation.queueId || undefined,
  channelType: conversation.channel as any,
  channelId: conversation.channelConnectionId || undefined,
});

// Despu√©s:
const metricId = `metric_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
metricsTracker.startConversation(metricId, conversation.id, advisorId, {
  queueId: conversation.queueId || undefined,
  channelType: conversation.channel as any,
  channelId: conversation.channelConnectionId || undefined,
});
```

#### 2. Correcci√≥n en `server/crm/routes/messages.ts` (l√≠nea 96)
```typescript
// Antes:
metricsTracker.startConversation(conversation.id, advisorId, {
  queueId: conversation.queueId || undefined,
  channelType: conversation.channel as any,
  channelId: conversation.channelConnectionId || undefined,
});

// Despu√©s:
const metricId = `metric_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
metricsTracker.startConversation(metricId, conversation.id, advisorId, {
  queueId: conversation.queueId || undefined,
  channelType: conversation.channel as any,
  channelId: conversation.channelConnectionId || undefined,
});
```

#### 3. Limpieza de datos corruptos en PostgreSQL
```bash
# Identificar filas corruptas (advisor_id como JSON)
PGPASSWORD=azaleia_pg_2025_secure psql -h localhost -U whatsapp_user -d flowbuilder_crm \
  -c "SELECT COUNT(*) FROM conversation_metrics WHERE advisor_id LIKE '{%';"
# Resultado: 81 filas

# Eliminar filas corruptas
PGPASSWORD=azaleia_pg_2025_secure psql -h localhost -U whatsapp_user -d flowbuilder_crm \
  -c "DELETE FROM conversation_metrics WHERE advisor_id LIKE '{%';"
# Eliminadas: 81 filas
```

#### 4. Reinicio del servicio
```bash
systemctl restart flowbuilder
systemctl status flowbuilder
```

### Verificaci√≥n
Despu√©s del fix, la base de datos solo contiene `advisor_id` v√°lidos:
```sql
SELECT id, advisor_id FROM conversation_metrics LIMIT 10;
-- Todos los advisor_id son strings v√°lidos: 'user-1', 'user-1761954513456', etc.
```

### Impacto
- ‚úÖ La tabla "M√©tricas de Asesores" ahora muestra nombres correctos
- ‚úÖ Los datos de m√©tricas son consistentes  
- ‚úÖ No m√°s objetos JSON en la interfaz
- ‚úÖ El endpoint `/api/crm/metrics/advisors/ranking` devuelve datos correctos


---

## Fix: Transferencias y Categor√≠as (9 Nov 2025 - 23:43)

### Problema 1: Transferencias no Respetan Flujo de Categor√≠as

**S√≠ntoma**: Al transferir un chat de un asesor a otro, el chat quedaba en "TRABAJANDO" (attending) en lugar de ir a "POR TRABAJAR" (active).

**Causa**: El endpoint `/transfer` no estaba cambiando el `status` a "active" al transferir a un asesor.

**Soluci√≥n**: 
```typescript
// En server/crm/routes/conversations.ts (l√≠nea 311-315)
await crmDb.updateConversationMeta(conversation.id, {
  assignedTo: targetId,
  assignedAt: Date.now(),
  status: "active",  // IMPORTANTE: Forzar a "active" para que vaya a POR TRABAJAR
});
```

**Flujo Correcto Ahora**:
1. Asesor A transfiere chat ‚Üí `assignedTo = Asesor B`, `status = "active"`
2. Chat aparece en **POR TRABAJAR** de Asesor B
3. Asesor B **acepta** el chat ‚Üí `status = "attending"`
4. Chat pasa a **TRABAJANDO** de Asesor B

---

### Problema 2: Error 400 al Transferir a Cola

**S√≠ntoma**: Al intentar transferir un chat a una cola: `400 (Bad Request)` con error `invalid_type`

**Causa**: El endpoint `/transfer` solo aceptaba `type: "advisor"` y `type: "bot"`, pero no `type: "queue"`

**Soluci√≥n Aplicada**:

#### 1. Validaci√≥n de tipo (l√≠nea 272):
```typescript
// Antes:
if (type !== "advisor" && type !== "bot") {
  res.status(400).json({ error: "invalid_type" });
  return;
}

// Despu√©s:
if (type !== "advisor" && type !== "bot" && type !== "queue") {
  res.status(400).json({ error: "invalid_type" });
  return;
}
```

#### 2. L√≥gica para transferir a cola (l√≠neas 319-329):
```typescript
} else if (type === "queue") {
  // Transferring to queue: remove assignedTo and set queueId
  const queue = adminDb.getQueueById(targetId);
  displayName = queue?.name || "Cola";

  await crmDb.updateConversationMeta(conversation.id, {
    assignedTo: null,  // Quitar el asesor asignado
    queueId: targetId, // Asignar a la cola
    status: "active",  // Estado activo (EN COLA)
  });
  console.log(`[CRM] ‚úÖ Conversation ${conversation.id} transferred to queue: ${displayName} (${targetId})`);
}
```

#### 3. Mensaje de sistema actualizado (l√≠neas 337-344):
```typescript
let transferText = "";
if (type === "advisor") {
  transferText = `üîÄ ${currentAdvisorName} transfiri√≥ a ${displayName} (${timestamp})`;
} else if (type === "queue") {
  transferText = `üìã ${currentAdvisorName} transfiri√≥ a cola ${displayName} (${timestamp})`;
} else {
  transferText = `ü§ñ ${currentAdvisorName} transfiri√≥ a bot ${displayName} (${timestamp})`;
}
```

---

## Reglas de Categor√≠as para Transferencias

### Transferencia a Asesor (`type: "advisor"`)
- `assignedTo` = nuevo asesor
- `status` = "active" (forzado)
- **Categor√≠a**: POR TRABAJAR
- **Requiere**: Aceptaci√≥n del nuevo asesor
- **Flujo**: Transferir ‚Üí POR TRABAJAR ‚Üí Aceptar ‚Üí TRABAJANDO

### Transferencia a Cola (`type: "queue"`)
- `assignedTo` = null (sin asesor)
- `queueId` = ID de la cola
- `status` = "active"
- **Categor√≠a**: EN COLA / BOT
- **Flujo**: Transferir ‚Üí EN COLA ‚Üí Asesor toma ‚Üí POR TRABAJAR ‚Üí Aceptar ‚Üí TRABAJANDO

### Transferencia a Bot (`type: "bot"`)
- Solo actualiza metadata
- No cambia `assignedTo` ni `status`

### Tomar Control (`/takeover`)
- `assignedTo` = nuevo asesor
- `status` = "attending" (directo)
- **Categor√≠a**: TRABAJANDO (directo, sin pasar por POR TRABAJAR)
- **Diferencia**: Es una acci√≥n m√°s agresiva que no requiere aceptaci√≥n

---

## Priorizaci√≥n de Categor√≠as (Recordatorio)

Un chat solo puede estar en **UNA categor√≠a a la vez**:

1. **MASIVOS** üî¥ - `campaignId != null` AND `status = "closed"`
2. **EN COLA / BOT** üü° - `assignedTo == null`
3. **POR TRABAJAR** üîµ - `assignedTo != null` AND `status == "active"`
4. **TRABAJANDO** üü¢ - `status == "attending"`
5. **FINALIZADOS** ‚ö´ - `status == "archived" || status == "closed"` (sin campaignId)

---

## Archivos Modificados en Esta Sesi√≥n

1. **server/crm/routes/conversations.ts**
   - L√≠nea 393: Fix de startConversation (agregado metricId)
   - L√≠nea 272: Validaci√≥n de type para incluir "queue"
   - L√≠nea 314: Forzar status="active" en transferencias a asesor
   - L√≠neas 319-329: L√≥gica para transferir a cola
   - L√≠neas 337-344: Mensajes de sistema para transferencias
   - L√≠neas 430-526: Restauraci√≥n del endpoint /takeover

2. **server/crm/routes/messages.ts**
   - L√≠nea 96: Fix de startConversation (agregado metricId)

3. **Base de datos PostgreSQL**
   - Eliminadas 81 filas corruptas con advisor_id como JSON

---

## Testing Recomendado

- [ ] Transferir chat de Asesor A a Asesor B ‚Üí Verificar que aparezca en POR TRABAJAR
- [ ] Asesor B acepta chat transferido ‚Üí Verificar que pase a TRABAJANDO
- [ ] Transferir chat a una cola ‚Üí Verificar que aparezca en EN COLA / BOT
- [ ] Tomar control de chat con /takeover ‚Üí Verificar que vaya directo a TRABAJANDO
- [ ] Verificar que m√©tricas de asesores no muestren objetos JSON

---

**√öltima actualizaci√≥n**: 9 Nov 2025 - 23:51
**Estado del servicio**: ‚úÖ Corriendo sin errores
**Pendiente**: Testing de todas las funcionalidades de transferencia

